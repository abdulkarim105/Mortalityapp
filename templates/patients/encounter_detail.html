
{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h1 class="h3 mb-0">Encounter #{{ encounter.id }}</h1>
    <div class="text-muted">
      {{ encounter.patient.full_name }} — MRN {{ encounter.patient.mrn }} — {{ encounter.unit|default:"Unit n/a" }}
    </div>
  </div>
  <div class="d-flex gap-2">
    {% if perms.observations.add_observationset %}
      <a class="btn btn-outline-primary" href="{% url 'observations:obs_create' encounter.id %}">Enter vitals/labs</a>
    {% endif %}
    {% if perms.risk.add_riskassessment %}
      <a class="btn btn-primary" href="{% url 'risk:generate' encounter.id %}">Generate risk</a>
    {% endif %}
  </div>
</div>

{% if latest_risk %}
  <div class="alert alert-info">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <strong>Latest 180-day risk:</strong>
        {{ latest_risk.risk_180d|floatformat:3 }} ({{ latest_risk.risk_band }})
        <div class="small text-muted">Generated {{ latest_risk.created_at }} by {{ latest_risk.created_by }}</div>
      </div>
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'risk:detail' latest_risk.id %}">View</a>
    </div>
  </div>
{% endif %}

<div class="row g-3">
  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h5">Observation sets</h2>
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead><tr><th>Time</th><th>Recorded by</th><th></th></tr></thead>
            <tbody>
              {% for o in obs_list %}
                <tr>
                  <td>{{ o.recorded_at }}</td>
                  <td>{% if o.recorded_by_name %}
                     {{ o.recorded_by_name }}
                     {% elif o.recorded_by %}
                     {{ o.recorded_by }}
                      {% else %}
                       —
                     {% endif %}</td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-outline-secondary" href="{% url 'observations:obs_detail' o.id %}">Open</a>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="3" class="text-muted">No observation sets yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h2 class="h5">Risk assessments</h2>
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead><tr><th>Time</th><th>Risk</th><th>Band</th><th></th></tr></thead>
            <tbody>
              {% for r in risk_list %}
                <tr>
                  <td>{{ r.created_at }}</td>
                  <td>{{ r.risk_180d|floatformat:3 }}</td>
                  <td>{{ r.risk_band }}</td>
                  <td class="text-end">
                    <a class="btn btn-sm btn-outline-secondary" href="{% url 'risk:detail' r.id %}">Open</a>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="4" class="text-muted">No assessments yet.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<p class="mt-3">
  <a href="{% url 'patients:patient_detail' encounter.patient.id %}">&larr; Back to patient</a>
</p>
{% endblock %}
