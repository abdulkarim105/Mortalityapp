{% extends "base.html" %}
{% block content %}

<h2>Risk assessment #{{ ra.id }}</h2>
<p class="text-muted">
  Encounter #{{ ra.encounter.id }} • Predicted by {{ ra.doctor_name }} • {{ ra.created_at }}
</p>

<div class="row">
  <div class="col-md-4">

    <!-- Risk card -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5>180-day mortality risk</h5>
        <div class="display-6">{{ ra.risk_180d|floatformat:2 }}%</div>

        {% if ra.risk_band == "HIGH" %}
          <span class="badge bg-danger">High risk</span>
        {% elif ra.risk_band == "MEDIUM" %}
          <span class="badge bg-warning text-dark">Medium risk</span>
        {% else %}
          <span class="badge bg-success">Low risk</span>
        {% endif %}
      </div>
    </div>

    <!-- Doctor comment -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5>Doctor comment</h5>

        <form method="post">
          {% csrf_token %}
          {{ comment_form.doctor_comment }}
          <button type="submit" class="btn btn-primary">
              Save comment
          </button>
        </form>
      </div>
    </div>

    <!-- Drivers -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h5>Clinically interpretable risk drivers</h5>
        <p class="text-muted">
          High severity: {{ high_count }} | Abnormal total: {{ total_abnormal }}
        </p>

        <ul class="mb-0">
          {% for d in drivers %}
            <li class="mb-2">
              {{ d.icon }} {{ d.text }}

              {% if d.severity == "TOO HIGH" or d.severity == "TOO LOW" %}
                <span class="badge bg-danger">{{ d.severity|lower }}</span>
              {% else %}
                <span class="badge bg-warning text-dark">{{ d.severity|lower }}</span>
              {% endif %}
            </li>
          {% empty %}
            <li class="text-muted">No abnormal drivers detected.</li>
          {% endfor %}
        </ul>

        {% if total_abnormal > shown_count %}
          <a href="?all=1">Show all abnormal values</a>
        {% endif %}
      </div>
    </div>

    <!-- SHAP contributors (NEW, below clinical drivers) -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h5>Top SHAP contributors</h5>
        <p class="text-muted mb-2">
          Ranked by absolute contribution to predicted mortality risk (highest first).
        </p>

        {% if top_shap %}
          <ul class="mb-0">
            {% for item in top_shap %}
              <li class="mb-2">
                {% if item.direction == "up" %}
                  <span class="badge bg-danger me-2">↑ increases</span>
                {% elif item.direction == "down" %}
                  <span class="badge bg-success me-2">↓ decreases</span>
                {% else %}
                  <span class="badge bg-secondary me-2">no effect</span>
                {% endif %}

                <strong>{{ item.feature }}</strong>
                = {{ item.value|default:"—" }}
                <span class="text-muted ms-2">(SHAP: {{ item.shap_value|floatformat:4 }})</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-muted">No SHAP values available.</div>
        {% endif %}
      </div>
    </div>

  </div>

  <!-- Inputs -->
  <div class="col-md-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5>Inputs used</h5>
        <table class="table table-sm">
          {% for k,v in features %}
          <tr>
            <td>{{ k }}</td>
            <td>{{ v|default:"—" }}</td>
          </tr>
          {% endfor %}
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}
